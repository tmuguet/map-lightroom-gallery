<%
--[[
Map Lightroom Web Gallery - https://github.com/tmuguet/map-lightroom-gallery

Copyright (c) 2017 Thomas Muguet (https://tmuguet.me)
Portions Copyright (c) 2015-2016 Justin Briggs (http://trialstravails.blogspot.com) from The Gallerific Lightroom Web Gallery

Licensed under the MIT License:
   http://www.opensource.org/licenses/mit-license.php
 ]]
%>
<%

function addSlash(url)
	if ( url ~= "" and string.sub(url,-1,-1) == "/" ) then
		return url
	else
		return url .. "/"
	end
end

function round(n, precision)
	local divisor = 10^(precision)
	return math.floor(n * divisor + 0.5) / divisor
end

--[[ Define some variables to make locating other resources easier]]
local imgDir = "im"
local theRoot = "./res"
local imgFn = ""
local featuredImgIndex = tonumber(model.nonCSS.featuredImageIndex)
featuredImgIndex = (featuredImgIndex ~= nil and featuredImgIndex>=1 and featuredImgIndex<=numImages) and round(featuredImgIndex,1) or 1
local featuredImage = imgDir .. "/lg/" .. getImage(featuredImgIndex).exportFilename .. ".jpg"
local canonicalUrl = addSlash(model.metadata.canonicalUrlBase) .. "index.html"

local LrApplication = import 'LrApplication'
local catalog = LrApplication.activeCatalog ()
local idToPhoto = {}
for _, photo in ipairs (catalog:getAllPhotos ()) do
    idToPhoto [photo.localIdentifier] = photo
end

function getMapData(im, photo)
    local content=""
    local gpsCoords = photo:getRawMetadata("gps")

    if (gpsCoords ~= nil) then
        content = "data-lat='" .. gpsCoords['latitude'] .. "' data-lng='" .. gpsCoords['longitude'] .. "' data-zoom='17'"
    end
    return content
end

function stripTags(str)
	return string.gsub(str, "(%b<>)", "")
end

-- Remove emptiness from caption comments generated by LR (remove empty punctuation [up to 4 consecutive] and groupings, trim, remove remaining punctuation at edges)
function myStrip(str) -- "%(" eg escapes (, "%s-" is 0..many spaces, minimally matched
	str = str:gsub(",%s-,",","):gsub(";%s-;",";"):gsub("%.%s-%.","."):gsub(",%s-,",","):gsub(";%s-;",";"):gsub("%.%s-%.",".") -- punctuation
	str = str:gsub("[%[%({]+[;,%.%s]-[%]%)}]+",""):gsub("([%[%({]+)[;,%.%s]+","%1"):gsub("[;,%.%s]+([%]%)}]+)","%1") -- empty groupings and punctuation at inside ends of groupings
	return str:gsub("^[;,%.%s]*(.-)[;,%.%s]*$", "%1") -- trim, including punctuation at ends of string
end

%>
<% --[[ Include the page header]] %>
<%@ include file="header.html" %>


		<div id="cover-container">
    		<div>
                <div id="cover">
                    <h2>$model.metadata.collectionTitle.value</h2>
                    <p>$model.metadata.collectionDescription.value</p>
                    <div>
                        <canvas id="chart" width="100%" height="100%"></canvas>
                    </div>
                </div>
                <div id="thumbs">
                    <ul>
    <li></li><lr:ThumbnailGrid><lr:GridPhotoCell><li>
    <% imgFn = image.exportFilename .. ".jpg" %>
    <a class="thumb" href="#<%= cellIndex %>" data-img-lg="$imgDir/lg/$imgFn" data-img-fl="$imgDir/fl/$imgFn" style="background-image: url('$imgDir/th/$imgFn');" <%= getMapData(image, idToPhoto [image.imageID]) %>></a>
    <div class="caption">
        <div class="image-title"><%= myStrip(image.metadata.title) %></div>
        <div class="image-desc"><%=  myStrip(image.metadata.description) %></div>
    </div>
</li></lr:GridPhotoCell>
<lr:GridRowEnd></lr:GridRowEnd>
</lr:ThumbnailGrid>
</ul>
                </div>
            </div>
		</div>

<% --[[ Include the page footer]] %>
<%@ include file="footer.html" %>
