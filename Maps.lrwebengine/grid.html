<%
--[[
Map Lightroom Web Gallery - https://github.com/tmuguet/map-lightroom-gallery

Copyright (c) 2017 Thomas Muguet (https://tmuguet.me)
Portions Copyright (c) 2015-2016 Justin Briggs (http://trialstravails.blogspot.com) from The Gallerific Lightroom Web Gallery

Licensed under the MIT License:
   http://www.opensource.org/licenses/mit-license.php
 ]]
%>
<%

function addSlash(url)
	if ( url ~= "" and string.sub(url,-1,-1) == "/" ) then
		return url
	else
		return url .. "/"
	end
end

function round(n, precision)
	local divisor = 10^(precision)
	return math.floor(n * divisor + 0.5) / divisor
end

--[[ Define some variables to make locating other resources easier]]
local imgDir = "im"
local theRoot = "./res"
local imgFn = ""
local featuredImgIndex = tonumber(model.nonCSS.featuredImageIndex)
featuredImgIndex = (featuredImgIndex ~= nil and featuredImgIndex>=1 and featuredImgIndex<=numImages) and round(featuredImgIndex,1) or 1
local featuredImage = imgDir .. "/lg/" .. getImage(featuredImgIndex).exportFilename .. ".jpg"
local canonicalUrl = addSlash(model.metadata.canonicalUrlBase) .. "index.html"

--[[ Convert DMS to Decimal Degrees ]]
function latlongDMStoDD(dms)
	local deg = 0.0
	local divisor = 1
	for w in string.gfind(dms, "%d+") do
		deg = deg + w/divisor
		divisor = divisor*60
	end
	deg = round(deg, 7)
	local hemi = string.match(dms, "%u")
	if hemi == "S" or hemi == "W" then
		deg = -deg
	end
	return deg
end

--[[ Convert GPS coords to [lat, lng] table ]]
function gpsToLL(gpsData)
    local m = {}; i = 1
    for str in string.gfind(gpsData, "%d+%W+%d+%W+%d+%W+%u") do
		m[i] = latlongDMStoDD(str);  i = i + 1
	end

    return m
end

function getMapData(im)
    local content=""
	local m = {}; i = 1
	for str in string.gmatch(im.metadata.locationData, "([^;]*);;") do
		m[i] = str;  i = i + 1
	end
	local sublocation = m[1];	local city        = m[2]
	local state       = m[3];	local country     = m[4]
	local gpsCoords   = m[5]

    if (gpsCoords ~= "") then
        local llCoords = gpsToLL(gpsCoords)
        content = "data-lat='" .. llCoords[1] .. "' data-lng='" .. llCoords[2] .. "' data-zoom='17'"
    end
    return content
end

function stripTags(str)
	return string.gsub(str, "(%b<>)", "")
end

-- Remove emptiness from caption comments generated by LR (remove empty punctuation [up to 4 consecutive] and groupings, trim, remove remaining punctuation at edges)
function myStrip(str) -- "%(" eg escapes (, "%s-" is 0..many spaces, minimally matched
	str = str:gsub(",%s-,",","):gsub(";%s-;",";"):gsub("%.%s-%.","."):gsub(",%s-,",","):gsub(";%s-;",";"):gsub("%.%s-%.",".") -- punctuation
	str = str:gsub("[%[%({]+[;,%.%s]-[%]%)}]+",""):gsub("([%[%({]+)[;,%.%s]+","%1"):gsub("[;,%.%s]+([%]%)}]+)","%1") -- empty groupings and punctuation at inside ends of groupings
	return str:gsub("^[;,%.%s]*(.-)[;,%.%s]*$", "%1") -- trim, including punctuation at ends of string
end

%>
<% --[[ Include the page header]] %>
<%@ include file="header.html" %>


		<div id="cover-container">
    		<div>
                <div id="cover">
                    <h2>$model.metadata.collectionTitle.value</h2>
                    <p>$model.metadata.collectionDescription.value</p>
                    <div>
                        <canvas id="chart" width="100%" height="100%"></canvas>
                    </div>
                </div>
                <div id="thumbs">
                    <ul>
    <li></li><lr:ThumbnailGrid><lr:GridPhotoCell><li>
    <% imgFn = image.exportFilename .. ".jpg" %>
    <a class="thumb" href="#<%= cellIndex %>" data-img-lg="$imgDir/lg/$imgFn" data-img-fl="$imgDir/fl/$imgFn" style="background-image: url('$imgDir/th/$imgFn');" <%= getMapData(image) %>></a>
    <div class="caption">
        <div class="image-title"><%= myStrip(image.metadata.title) %></div>
        <div class="image-desc"><%=  myStrip(image.metadata.description) %></div>
    </div>
</li></lr:GridPhotoCell>
<lr:GridRowEnd></lr:GridRowEnd>
</lr:ThumbnailGrid>
</ul>
                </div>
            </div>
		</div>

<% --[[ Include the page footer]] %>
<%@ include file="footer.html" %>
